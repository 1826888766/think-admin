<div class="layui-card">
    <style>
        .layui-table, .layui-table-view {
            margin: 0 !important;
        }
    </style>
    <div class="layui-card-body">
        <div class="layui-tab" lay-filter="module">
            <ul class="layui-tab-title">
                {volist name="$module" id="vo"}
                <li lay-id="{$vo.id}" class="{$key==0?'layui-this':''}">
                    {$vo.name}
                    <span style="margin-left: 10px"><i onclick=add('',{module_id:'{$vo.id}'})
                                                       class="layui-icon layui-icon-add-circle"></i></span>
                </li>
                {/volist}
            </ul>
        </div>
        <table class="layui-table" style="margin: 0" lay-filter="myTable" id="myTable"></table>

    </div>
</div>
<script type="text/html" id="toolsTpl">
    <div class="layui-btn-group">
        <span class="layui-btn layui-btn-xs" onclick="add('{{d.id}}');">添加</span>
        <span class="layui-btn layui-btn-xs" onclick="edit('{{d.id}}');">编辑</span>
        <span class="layui-btn layui-btn-xs layui-btn-danger" onclick="del('{{d.id}}');">删除</span>
    </div>
</script>
<script>
    var $;
    layui.use(['treeTable', 'form', 'laytpl', "jquery", "element"], function () {
        var table = layui.treeTable;
        var element = layui.element;
        $ = layui.jquery;
        var config = {
            elem: '#myTable',// 必须
            url: "{:url('index')}",
            icon_key: 'name',// 必须
            top_value: 0,
            primary_key: 'id',
            parent_key: 'parent_id',
            hide_class: 'layui-hide',
            icon: {
                open: 'layui-icon layui-icon-triangle-d',
                close: 'layui-icon layui-icon-triangle-r',
                left: 20,
            },
            where: {
                module_id: "{$module[0]['id']}",
            },
            cols: [
                {key: 'name', title: '名称', width: '100px'},
                {key: 'sort', title: '排序', width: '100px'},
                {key: 'status', title: '状态', width: '100px'},
                {key: 'is_auth', title: '是否验权', width: '100px'},
                {key: 'is_show', title: '是否显示', width: '100px'},
                {key: 'target', title: '跳转方式', width: '100px'},
                {key: 'is_plugin', title: '是否插件', width: '100px'},
                {
                    key: 'tools', title: '操作', width: '150px', template: function (d) {
                        return layui.laytpl($("#toolsTpl").html()).render(d)
                    }
                },
            ],
            checked: {
                key: 'id',
                data: [],
            },
            is_click_icon: true,
            is_checkbox: true,
            is_cache: true,
            end: function (e) {
            },
        };
        element.on('tab(module)', function (obj) {
            config.where = {
                module_id: $(this).attr('lay-id')
            }
            table.render(config)
        });
        table.render(config)
    })

    function add(id) {
        var url = '{:url("add")}'
        var params = {}
        if (id) {
            params['id'] = id;
        }
        if (!params.hasOwnProperty('module_id')) {
            params['module_id'] = $('.layui-tab-title .layui-this').attr('lay-id')
        }
        layerOpen(url, params)
    }
    function edit(id) {
        var url = '{:url("edit")}'
        var params = {
            id:id
        }
        if (!params.hasOwnProperty('module_id')) {
            params['module_id'] = $('.layui-tab-title .layui-this').attr('lay-id')
        }
        layerOpen(url, params)
    }

    function del(url, params) {
        layui.$.post(url, params, function (res) {
            layer.msg(res.msg)
            if (res.code == 0) {
                layui.ml.tableInstance.reload()
            }
        })
    }
</script>